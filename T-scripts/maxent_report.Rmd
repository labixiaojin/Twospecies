---
title: "`r params$species` Maxent Modeling Report"
output: html_document
params:
  species: "Az.dexteroporum"
  scientific_name: "Dexteroporum az."
  region: "Northern South China Sea"
  occurrence_count: 42
  model_dir: "/Volumes/Rui's Mac/two_species/test/T-model_output"
  response_pattern: "Az.dexteroporum_response_curve_.*\\.png"
  optimal_params: "Az.dexteroporum_optimal_params.csv"
  response_curve_dir: "/Volumes/Rui's Mac/two_species/test/T-model_output"
  jackknife_plot: "Az.dexteroporum_jackknife_plot_horizontal.png"
  jackknife_table: "Az.dexteroporum_jackknife.csv"
  prediction_raster_path: "Az.dexteroporum_prediction.png"
  extra_figures_dir: "/Volumes/Rui's Mac/two_species/test/T-model_output"
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Load required packages
library(knitr)
library(dplyr)
library(stringr)
library(tibble)
library(purrr)
library(glue)
library(readr)

# Normalize paths without modifying params
model_dir_normalized <- normalizePath(params$model_dir, mustWork = FALSE)
response_curve_dir_normalized <- normalizePath(params$response_curve_dir, mustWork = FALSE)
extra_figures_dir_normalized <- normalizePath(params$extra_figures_dir, mustWork = FALSE)

# Preload data
optimal_params_df <- if (file.exists(file.path(model_dir_normalized, params$optimal_params))) {
  read_csv(file.path(model_dir_normalized, params$optimal_params), show_col_types = FALSE)
} else {
  NULL
}
jackknife_table_df <- if (file.exists(file.path(model_dir_normalized, params$jackknife_table))) {
  read_csv(file.path(model_dir_normalized, params$jackknife_table), show_col_types = FALSE)
} else {
  NULL
}

# Set knitr options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

## 1. Species Information
- **Common Name**: `r params$species`
- **Scientific Name**: `r params$scientific_name`
- **Region**: `r params$region`
- **Occurrence Points**: `r params$occurrence_count`
- **Generated Time**: `r Sys.time()`

## 2. Optimal Parameters

Below is the optimal combination of feature classes and regularization multiplier:
```{r optimal_params, echo=FALSE}
if (!is.null(optimal_params_df)) {
  kable(optimal_params_df, caption = "Optimal Parameters", align = "ll")
} else {
  cat("Optimal parameters table not found: ", file.path(model_dir_normalized, params$optimal_params), "\nPlease verify the file exists.")
}
```

## 3. Response Curves
```{r response_curves, results='asis'}
pattern <- params$response_pattern
imgs <- list.files(params$response_curve_dir, pattern = pattern, full.names = TRUE)
if (length(imgs) > 0) {
  for (img in imgs) {
    cat(sprintf("<img src='%s' width='30%%' style='display:inline-block;margin:8px;'/>", img))
  }
} else {
  cat("No response curve images found. Please check path: ", params$response_curve_dir, 
      " or pattern: ", pattern, "\nFiles in directory: ", 
      paste(list.files(params$response_curve_dir), collapse = ", "))
}
```

## 4. Jackknife Analysis
### Jackknife Variable Importance Plot
```{r jackknife_plot, results='asis'}
jk_plot_path <- file.path(model_dir_normalized, params$jackknife_plot)
if (file.exists(jk_plot_path)) {
  rel_jk <- basename(jk_plot_path)
  cat(glue::glue('<img src="{rel_jk}" width="45%" style="display:inline-block;margin:8px;"/>'))
} else {
  cat("Jackknife plot not found: ", jk_plot_path)
}
```

### Jackknife Results Table
```{r jackknife_table}
if (!is.null(jackknife_table_df)) {
  kable(jackknife_table_df, caption = "Jackknife Results")
} else {
  cat("Jackknife results table not found: ", file.path(model_dir_normalized, params$jackknife_table), "\nPlease verify the file exists.")
}
```

## 5. Predicted Probability Raster
```{r prediction_raster, results='asis'}
img_name <- paste0(params$species, "_prediction.png")
cat("Predicted Probability Raster Path: ", img_name, "\n\n")
if (file.exists(img_name)) {
  cat(sprintf("<img src='%s' width='60%%' style='display:block;margin:12px auto;'/>", img_name))
} else {
  cat(sprintf("Raster image not found: %s", img_name))
}
```

## 6. Additional Figures
```{r extra_figures, results='asis'}
shown_imgs <- c(
  list.files(".", pattern = params$response_pattern, full.names = TRUE),
  normalizePath(params$jackknife_plot, mustWork = FALSE),
  normalizePath(params$prediction_raster_path, mustWork = FALSE)
)
```

## 7. Report Notes
- This report is automatically generated by the Maxent modeling script. All parameters and results are rendered based on the input data.
- Response curves, Jackknife plots, and other visualizations support batch processing.
- For further analysis or report customization, please contact the technical team.

---