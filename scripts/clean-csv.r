# ===========================================================
# ç‰©ç§å‡ºç°ç‚¹ CSV æ‰¹é‡æ¸…æ´—ä¸æ ‡å‡†åŒ–è„šæœ¬
# â€”â€” æ¨èæ¯æ¬¡è¿è¡Œå‰è‡ªåŠ¨æ¸…ç† R ç¯å¢ƒ
# ===========================================================

# -----------------------------------------------------------
# 0. æ¸…ç† R ç¯å¢ƒï¼ˆå¼ºçƒˆå»ºè®®æ¯æ¬¡æ‰§è¡Œå‰ï¼‰
# -----------------------------------------------------------
rm(list = ls())                         # æ¸…ç©ºæ‰€æœ‰å¯¹è±¡
if (!is.null(dev.list())) dev.off()     # å…³é—­å›¾å½¢è®¾å¤‡
cat("\014")                             # æ¸…å±
gc()                                    # å›æ”¶å†…å­˜

# -----------------------------------------------------------
# 1. ä¾èµ–åŒ…è‡ªåŠ¨å®‰è£…å¹¶åŠ è½½
# -----------------------------------------------------------
packages  <- c("dplyr", "readr", "sf")  # ä¾èµ–åŒ…åˆ—è¡¨
new_pkgs  <- packages[!(packages %in% installed.packages()[, "Package"])]
if (length(new_pkgs)) install.packages(new_pkgs)
lapply(packages, library, character.only = TRUE)

# -----------------------------------------------------------
# 2. è·¯å¾„ä¸ç‰©ç§é…ç½®
# -----------------------------------------------------------
base_dir   <- "/Volumes/Rui's Mac/two_species/test"
input_dir  <- file.path(base_dir, "T-occurrences")
output_dir <- file.path(base_dir, "T-cleaned_points")                # æ¸…æ´—åè¾“å‡ºç›®å½•
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)      # è‡ªåŠ¨åˆ›å»ºè¾“å‡ºç›®å½•ï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰

species_files <- c("Am.languida.csv", "Az.dexteroporum.csv")        # åŸå§‹ç‰©ç§ CSV æ–‡ä»¶å
species_names <- c("Am.languida", "Az.dexteroporum")                # ç‰©ç§åç§°ï¼ˆä¸æ–‡ä»¶é¡ºåºå¯¹åº”ï¼‰

# ===========================================================
# 3. ç‰©ç§æ‰¹é‡å¤„ç†ä¸»å¾ªç¯
# ===========================================================
for (i in seq_along(species_files)) {
  # ---------------------------------------------------------
  # 3.1. è¯»å–åŸå§‹æ•°æ®
  # ---------------------------------------------------------
  input_path <- file.path(input_dir, species_files[i])
  sp_name    <- species_names[i]
  raw        <- read_csv(input_path, show_col_types = FALSE)
  
  # ---------------------------------------------------------
  # 3.2. å­—æ®µåæ ‡å‡†åŒ–ä¸æ£€æŸ¥
  # ---------------------------------------------------------
  colnames(raw) <- tolower(colnames(raw))    # å…¨éƒ¨åˆ—åå°å†™ï¼Œä¾¿äºåç»­æ“ä½œ
  if (!all(c("longitude", "latitude") %in% names(raw))) {
    stop(paste0("âŒ æ–‡ä»¶ ", species_files[i], " ç¼ºå°‘ Longitude/Latitude å­—æ®µ"))
  }
  
  # ---------------------------------------------------------
  # 3.3. æ¸…æ´—ä¸æ ‡å‡†åŒ–
  #      ï¼ˆå»é‡ã€å»NAã€åŠ ç‰©ç§åï¼‰
  # ---------------------------------------------------------
  cleaned <- raw %>%
    select(lon = longitude, lat = latitude) %>%   # ä»…ä¿ç•™ç»çº¬åº¦ï¼Œå¹¶é‡å‘½å
    filter(!is.na(lon) & !is.na(lat)) %>%         # å»é™¤ç¼ºå¤±å€¼
    distinct() %>%                                # å»é‡
    mutate(species = sp_name) %>%                 # å¢åŠ ç‰©ç§ååˆ—
    select(species, lon, lat)                     # ä¿æŒåˆ—é¡ºåºä¸€è‡´
  
  cat("âœ…", sp_name, "ï¼šæœ‰æ•ˆç‚¹ä½", nrow(cleaned), "\n")
  
  # ---------------------------------------------------------
  # 3.4. ä¿å­˜ä¸ºæ ‡å‡† CSV
  # ---------------------------------------------------------
  write_csv(cleaned, file.path(output_dir, paste0(sp_name, "_cleaned.csv")))
  
  # ---------------------------------------------------------
  # 3.5. å¯¼å‡ºä¸º Shapefileï¼ˆWGS84 åæ ‡ï¼‰
  # ---------------------------------------------------------
  shp <- st_as_sf(cleaned, coords = c("lon", "lat"), crs = 4326)
  st_write(shp, dsn = file.path(output_dir, paste0(sp_name, "_cleaned.shp")),
           delete_layer = TRUE, quiet = TRUE)
}

# -----------------------------------------------------------
# æ‰¹é‡æ¸…æ´—ç»“æŸï¼Œè¾“å‡ºå®Œæˆæç¤º
# -----------------------------------------------------------
cat("\nğŸ‰ ç‰©ç§ç‚¹æ¸…æ´—å…¨éƒ¨å®Œæˆï¼Œæ ‡å‡†åŒ–ç»“æœå·²è¾“å‡ºåˆ°ï¼š", output_dir, "\n")
